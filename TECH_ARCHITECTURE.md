# ТЕХНИЧЕСКАЯ АРХИТЕКТУРА: ML, данные, фичи, таргеты

## Ключевая идея: "Учишь на золоте, предсказываешь из меди"

```
ОБУЧЕНИЕ (NHANES — есть всё):
  X = CBC (14-18 фич) + BIOPRO (10-15 фич) + DEMO (5 фич) + анкета
  y = Body Iron < 0 мг/кг (из ферритина + sTfR по формуле Cook)

ПРОДАКШЕН (профосмотр / МИС — есть только рутина):
  X = ОАК-индексы (8 фич) + глюкоза + холестерин + пол + возраст + ИМТ
  -> модель выдаёт: P(дефицит железа) = 0.73
  -> триаж: "Рекомендован добор: ферритин +/- CRP"
```

---

## NHANES 2021-2023: Карта данных

### Ядро модели (обязательно)

| Файл | Содержание | Роль |
|---|---|---|
| `CBC_L.xpt` | ОАК: HGB, HCT, MCV, MCH, MCHC, RDW, RBC, WBC, PLT, MPV, формула | X (фичи) |
| `BIOPRO_L.xpt` | Биохимия: глюкоза, холестерин, ALT, AST, креатинин, альбумин, железо и др. | X (частично) |
| `DEMO_L.xpt` | Пол, возраст, раса, доход, образование | X (фичи) |
| `FERTIN_L.xpt` | Ферритин (LBXFER) | y (таргет) — часть формулы |
| `TFR_L.xpt` | Растворимый рецептор трансферрина (LBXTFR) | y (таргет) — часть формулы |

### Полезные для фичей (реалистично собрать в РФ)

| Файл | Берём | Аналог в РФ |
|---|---|---|
| `SMQ_L.xpt` | SMQ020 (ever smoked), SMQ040 (current) | Анкета профосмотра |
| `ALQ_L.xpt` | ALQ121 (частота), ALQ130 (доз/день) | Анкета (но врут) |
| `OCQ_L.xpt` | OCD150 (тип работы), OCQ180 (часы/нед) | Ядро 29н |
| `PAQ_L.xpt` | PAQ605-PAQ680 (интенсивность, время) | Можно спросить |

### Нужно скачать (критично!)

| Файл | Зачем | Аналог в 29н |
|---|---|---|
| **`BMX_L.xpt`** | ИМТ, рост, вес, окружность талии | ЕСТЬ в 29н! |
| **`BPX_L.xpt`** | Артериальное давление | ЕСТЬ в 29н! |
| **`RXQ_RX_L.xpt`** | Лекарства (НПВС -> ЖКТ-кровотечения -> ЖДА) | Можно спросить |
| **`MCQ_L.xpt`** | Мед. условия (диабет, рак, ХБП) | В мед. карте |

### Можно убрать (избыточно для MVP)

| Файл | Почему лишний |
|---|---|
| `DBQ_L.xpt` (99 переменных) | Избыточная диетология, в РФ не собирается |
| `DPQ_L.xpt` | Депрессия PHQ-9: не делают при 29н |
| `HSQ_L.xpt` | Субъективная самооценка здоровья: ненадёжно |
| `SMQFAM_L.xpt` | Курение в семье: для ЖДА нерелевантно |
| `SMQRTU_L.xpt` | Детали табака: избыточная гранулярность |

---

## Конструирование таргета (y)

### Вариант A: Ферритин < порога (простой, но шумный)

```python
y = 1 if ferritin < 15   # WHO-порог дефицита
y = 1 if ferritin < 30   # Более чувствительный (Lancet 2021)
```

Минус: ферритин — acute phase reactant. При воспалении ложно повышен -> пропуск ~30% случаев.

### Вариант B: Body Iron по формуле Cook (РЕКОМЕНДУЕМЫЙ)

```python
import numpy as np

body_iron = -(np.log10(sTfR / ferritin) - 2.8229) / 0.1207

y_iron_deficiency = (body_iron < 0).astype(int)           # Дефицит железа
y_ida = ((body_iron < 0) & (hgb < threshold)).astype(int)  # ЖДА (стадия 3)
# threshold: <12 г/дл женщины, <13 г/дл мужчины (WHO)
```

Плюс: sTfR НЕ зависит от воспаления. Чистый label.

### Вариант C: Мульти-критериальный

```python
y = 1 if (ferritin < 30) or (ferritin < 100 and sTfR_elevated)
```

### РЕШЕНИЕ: Вариант B (Body Iron) как основной, Вариант A как вторичный

---

## Фичи (X): Две модели

### Модель A — "29н-минимум" (~20 фичей)

Только то, что гарантированно есть при любом профосмотре:

```
Из CBC_L:
  LBXHGB, LBXHCT, LBXMCVSI, LBXMCHSI, LBXMC, LBXRDW,
  LBXRBCSI, LBXPLTSI, LBXMPSI, LBXWBCSI,
  LBXNEPCT, LBXLYPCT, LBXMOPCT, LBXEOPCT

Из BIOPRO_L:
  LBXSGL (глюкоза), LBXSCH (холестерин)

Из DEMO_L:
  RIAGENDR (пол), RIDAGEYR (возраст)

Из BMX_L (СКАЧАТЬ!):
  BMXBMI (ИМТ)

Из BPX_L (СКАЧАТЬ!):
  BPXOSY1 (сист. АД)
```

### Модель B — "расширенная" (+ ~10 фичей)

Всё из A плюс из BIOPRO_L:
```
  LBXSAL (альбумин), LBXSTP (общий белок), LBXSATSI (ALT),
  LBXSASSI (AST), LBXSTB (билирубин), LBXSLDSI (LDH),
  LBXSCR (креатинин), LBXSUA (мочевая кислота)
```

### Что НЕ брать как фичу

| Показатель | Почему |
|---|---|
| Ферритин (LBXFER) | Часть таргета = data leakage |
| sTfR (LBXTFR) | Часть таргета, в продакшене недоступен |
| Serum Iron (LBXSIR) | Не в 29н, суточная вариабельность 30%, если есть -> есть и ферритин |
| CRP | Нет в NHANES BIOPRO, нет в 29н, нет в рутине |

---

## Маппинг NHANES -> Реальность 29н

```
29н обязательно          ->  NHANES файл     ->  Переменные
------------------------------------------------------------
ОАК (HGB, MCV, RDW...)  ->  CBC_L.xpt       ->  14 фичей
Глюкоза                  ->  BIOPRO_L.xpt    ->  LBXSGL
Холестерин               ->  BIOPRO_L.xpt    ->  LBXSCH
Пол, возраст             ->  DEMO_L.xpt      ->  RIAGENDR, RIDAGEYR
ИМТ                      ->  BMX_L.xpt       ->  BMXBMI
АД                       ->  BPX_L.xpt       ->  BPXOSY1/BPXODI1
Профессия                ->  OCQ_L.xpt       ->  OCD150
Курение                  ->  SMQ_L.xpt       ->  SMQ020, SMQ040
```

Важно: MCV, MCH, MCHC, RDW, MPV — формально не в тексте 29н,
но 95% анализаторов выдают автоматически. Данные ЕСТЬ, просто не используются.

---

## Рефлекс-сценарии для MVP

### Сценарий 1: ОАК -> риск ЖДА -> ферритин +/- CRP

```
Вход: HGB, MCV, MCH, MCHC, RDW, PLT, WBC, нейтрофилы + пол + возраст
Выход: P(iron deficiency)
  Если P > 0.6 и нет сигнала воспаления (WBC N, PLT N) -> добор: ферритин
  Если P > 0.6 и ЕСТЬ сигнал воспаления -> добор: sTfR (или ферритин+CRP)
  Если P < 0.3 -> добор НЕ нужен
```

### Сценарий 2: Глюкоза/ИМТ -> риск преддиабета -> HbA1c

```
Вход: глюкоза натощак, ИМТ, возраст, пол, семейный анамнез
Выход: P(prediabetes)
  Если P > 0.5 -> добор: HbA1c
```

### Сценарий 3: Pre-analytical подсказки

```
Если врач назначил ферритин И в CBC WBC > 10 + нейтрофилы > 75%:
  -> "Внимание: признаки воспаления. Ферритин может быть ложнонормальным.
     Рекомендуем добавить CRP или заменить на sTfR."
```

---

## Алгоритмы и метрики

### Алгоритмы (из литературы)
- **CatBoost**: AUC-ROC 0.98 кросс-вал, 0.93 тест (CBC -> IDA, 2025)
- **XGBoost**: AUC 0.814 для дефицита без анемии (211K пациентов, BMJ Open 2025)
- **Random Forest**: AUC 0.92/0.90 для предсказания низкого ферритина (de Gruyter 2021)
- **MGH Smart Reflex**: AUC 0.731 для предсказания назначения ферритина (288K CBC-events)

### Метрики пилота
- Sensitivity (recall): >= 0.90 (не пропустить реальный дефицит)
- Specificity: >= 0.70 (не назначать лишнего)
- Калибровка: Brier score, calibration curve
- SHAP для интерпретируемости

### Важно: стратификация по полу
Разные пороги HGB: <12 г/дл для женщин, <13 г/дл для мужчин.
Модель должна учитывать это при обучении.

---

## Ключевой инсайт из MGH (Refleks.pdf)

Модель, обученная на Body Iron (ферритин + sTfR), предсказывающая из CBC:
- Уже скорректирована на воспаление (sTfR не зависит от воспаления)
- CBC содержит собственные маркеры воспаления (WBC, нейтрофилы, тромбоцитоз)
- "Предсказанный ферритин" может быть точнее измеренного у пациентов с воспалением

Это и есть главная ценность: CRP НЕ нужен ни как фича, ни как рекомендованный добор
в большинстве случаев. Модель сама учитывает воспалительный контекст.

---

## План действий (код)

```
Шаг 1: Скачать BMX_L.xpt, BPX_L.xpt, RXQ_RX_L.xpt, MCQ_L.xpt
Шаг 2: Загрузить и смержить по SEQN все файлы
Шаг 3: Вычислить Body Iron: BI = -(log10(sTfR/ferritin) - 2.8229) / 0.1207
Шаг 4: Определить X (Модель A: 20 фич; Модель B: 26 фич)
Шаг 5: Обучить CatBoost/XGBoost
Шаг 6: SHAP, калибровка, стратификация по полу
Шаг 7: Определить пороги для режимов (reflex / low-info / predict)
```
