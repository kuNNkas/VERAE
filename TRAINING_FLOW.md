# Флоу обучения моделей

## ⚠ КРИТИЧНОЕ ОГРАНИЧЕНИЕ: Применимость модели

**Body Iron target (Y_IRON_DEFICIENCY, Y_IDA) валидирован ТОЛЬКО для женщин 12-49 лет.**

- NHANES собирает sTfR (soluble transferrin receptor) только для женщин репродуктивного возраста
- **0% данных для мужчин**
- **0% данных для женщин ≥50 лет**
- Средний возраст в датасете: 29.4 года (медиана 29)

**→ Для пилота: таргетировать женщины 18-50 лет**  
**→ Для scale: собрать российские данные с sTfR для других групп или использовать ferritin-only target**

Подробнее: `LIMITATION_BODY_IRON.md`

---

## Данные: 3 сценария развёртывания

| Датасет | Фич | Полных строк (без NaN) | Применение |
|---------|-----|------------------------|-----------|
| **X_kdl.csv** | 17 | 99.8% | КДЛ (только лабораторные данные) |
| **X_29n.csv** | 25 | 87.8% | Корпоративный скрининг 29н |
| **X_ext.csv** | 40 | 6.8% | Полные данные (B2C, расширенный B2B) |

**Таргеты** (y.csv):
- `Y_IRON_DEFICIENCY` — дефицит железа (Body Iron < 0) — **447 положительных из 6303 (7.1%)**
- `Y_IDA` — железодефицитная анемия (BI<0 + низкий Hgb) — **392 положительных (6.2%)**

**Все 6303 наблюдения — женщины 12-49 лет.**

---

## Стратегия обучения: 3 этапа

### Этап 1: Baseline-эксперименты (все 3 датасета, оба таргета)

**Цель**: понять, какие данные дают лучшие метрики и какой таргет (ID vs IDA) релевантнее.

**Что делать**:

1. **Обучить 6 базовых моделей** (3 датасета × 2 таргета):

   | Модель | Данные | Таргет | Приоритет |
   |--------|--------|--------|-----------|
   | `model_kdl_id` | X_kdl | Y_IRON_DEFICIENCY | ★★★ Старт КДЛ |
   | `model_kdl_ida` | X_kdl | Y_IDA | ★★ Клиника "годен" |
   | `model_29n_id` | X_29n | Y_IRON_DEFICIENCY | ★★★ B2B работодатели |
   | `model_29n_ida` | X_29n | Y_IDA | ★★ B2B триаж |
   | `model_ext_id` | X_ext | Y_IRON_DEFICIENCY | ★★ B2C/расширенный |
   | `model_ext_ida` | X_ext | Y_IDA | ★ Валидация |

2. **Алгоритмы** (по литературе + нативная поддержка NaN):
   - **CatBoost** (приоритет 1) — лучший по литературе для медицинских данных, нативный NaN
   - **XGBoost** (приоритет 2) — для сравнения
   - **Logistic Regression** (baseline) — для интерпретируемости

3. **Обработка дисбаланса**:
   - CatBoost/XGBoost: `scale_pos_weight` или `class_weights` (1:13 для ID, 1:15 для IDA)
   - Или SMOTE (но аккуратно, чтобы не синтезировать шум)

4. **Train/Val/Test split**:
   - Stratified 70% / 15% / 15% по таргету
   - Или 5-fold Stratified CV (надёжнее при малых положительных)

5. **Метрики** (важны в порядке приоритета):
   - **AUROC** (главная) — способность различить риск
   - **AUPRC** (важна при дисбалансе) — precision-recall
   - **Specificity @ 90% Sensitivity** — сколько false positives при 90% чувствительности
   - **NPV @ threshold** — negative predictive value (важно для триажа "норма")
   - **Calibration plot** — насколько вероятности соответствуют реальным частотам

6. **Что смотреть**:
   - Какой датасет даёт лучший AUROC? (ожидание: 29n ≥ kdl, ext ≈ 29n из-за NaN)
   - Какой таргет (ID vs IDA) легче предсказывать? (ожидание: IDA проще, но ID полезнее)
   - Нет ли переобучения? (val AUROC vs test AUROC)

---

### Этап 2: Feature importance + клиническая валидация

**Цель**: понять, что модель "видит", и валидировать на клинической логике.

**Что делать**:

1. **SHAP analysis** для лучшей модели (например, `model_29n_id`):
   - Global importance: какие фичи важнее всего (ожидание: RDW, MCV, MCH, Hgb, тромбоциты)
   - Individual explanations: как модель объясняет конкретный случай (для карточек риска)
   - Force plot для 10-20 кейсов (высокий риск, низкий риск, пограничные)

2. **Корреляция с CRP** (воспаление):
   - Для пациентов с CRP > 5 мг/л: падает ли точность модели? (ожидание: нет, т.к. Body Iron уже учёл воспаление)
   - Распределение рисков модели при высоком/низком CRP
   - **Это критично для доказательства**, что модель не требует CRP как рефлекс-тест

3. **Partial dependence plots**:
   - MCV vs риск (ожидание: ниже MCV → выше риск)
   - RDW vs риск (выше RDW → выше риск)
   - Hgb vs риск (ниже Hgb → выше риск, но не линейно из-за Body Iron)

4. **Confusion matrix по полу/возрасту**:
   - Работает ли модель одинаково хорошо для мужчин/женщин? (почти все данные — женщины, это риск)
   - По возрастным группам (18-30, 30-50, 50+)

---

### Этап 3: Экономическая оптимизация порогов

**Цель**: найти оптимальный threshold для каждого сценария (КДЛ, 29н, B2C).

**Что делать**:

1. **ROC/PR кривые** для выбора порога:
   - Не обязательно threshold = 0.5
   - Например, для КДЛ (апсейл): нужен высокий precision (≥80%), чтобы не раздражать пациентов
   - Для 29н (триаж): нужен высокий recall (≥90%), чтобы не пропустить больничные

2. **Экономическая симуляция**:
   - **Сценарий КДЛ**: порог = ? → конверсия в добор = X% → доход = Y₽/пациент
   - **Сценарий 29н**: порог = ? → предотвращённые больничные = Z дней → ROI = W₽/сотрудник
   - **Сценарий B2C**: порог = ? → конверсия в чек-ап = K% → LTV = V₽

3. **Таблица решений** (для каждого порога):

   | Threshold | Sens | Spec | PPV | NPV | FP rate | Экономика |
   |-----------|------|------|-----|-----|---------|-----------|
   | 0.3 (liberal) | 95% | 60% | 15% | 99% | 40% | Высокий recall, но много FP → раздражение |
   | 0.5 (default) | 85% | 80% | 25% | 98% | 20% | Баланс |
   | 0.7 (strict) | 70% | 90% | 40% | 97% | 10% | Высокий precision → высокая конверсия |

4. **A/B-тест план**:
   - Рандомизация порогов в пилоте (например, 0.5 vs 0.7)
   - Метрики: конверсия в добор, NPS, жалобы, доход

---

## Итоговый чеклист: что обучать и смотреть

### Шаг 1: Baseline (1-2 дня)

- [ ] Обучить CatBoost на `X_kdl` → `Y_IRON_DEFICIENCY` (model_kdl_id)
- [ ] Обучить CatBoost на `X_29n` → `Y_IRON_DEFICIENCY` (model_29n_id)
- [ ] Обучить CatBoost на `X_ext` → `Y_IRON_DEFICIENCY` (model_ext_id)
- [ ] Для лучшей модели: обучить на `Y_IDA` для сравнения
- [ ] Логистическую регрессию на `X_29n` → `Y_IRON_DEFICIENCY` (baseline для интерпретации)
- [ ] Сохранить метрики: AUROC, AUPRC, Sensitivity/Specificity, NPV

**Критерий успеха**: AUROC ≥ 0.80 для `model_29n_id` (по литературе реалистично 0.80-0.85).

---

### Шаг 2: SHAP + валидация (1 день)

- [ ] SHAP global importance для лучшей модели (ожидание: RDW, MCV, MCH топ-3)
- [ ] SHAP force plots для 10 кейсов (высокий/низкий/пограничный риск)
- [ ] Корреляция риска с CRP: нет ли падения точности при CRP>5?
- [ ] Partial dependence: MCV, RDW, Hgb
- [ ] Confusion matrix по полу/возрасту

**Критерий успеха**: топ-фичи соответствуют литературе (RDW, MCV, MCH, Hgb), модель не зависит от CRP.

---

### Шаг 3: Пороги + экономика (1 день)

- [ ] ROC/PR кривые для выбора порога
- [ ] Экономическая симуляция для 3 сценариев (КДЛ, 29н, B2C)
- [ ] Таблица решений (Sens/Spec/PPV/NPV по порогам)
- [ ] A/B-тест план (рандомизация порогов)

**Критерий успеха**: для каждого сценария есть рекомендованный threshold с обоснованием.

---

## Приоритеты для пилота (что показывать первым)

1. **КДЛ/УКБ** → `model_kdl_id` (17 фич, AUROC ~0.80, threshold ~0.7 для precision)
2. **29н** → `model_29n_id` (25 фич, AUROC ~0.82, threshold ~0.5 для баланса)
3. **B2C** → `model_ext_id` (40 фич, AUROC ~0.83, threshold ~0.6)

---

## Файлы для сохранения

После обучения сохранить:

- `models/model_kdl_id.cbm` (CatBoost binary)
- `models/model_29n_id.cbm`
- `models/model_ext_id.cbm`
- `results/metrics.csv` (AUROC, AUPRC, Sens, Spec для всех моделей)
- `results/shap_importance.png` (global feature importance)
- `results/roc_curves.png` (ROC для 3 моделей)
- `results/calibration.png` (calibration plot)
- `results/thresholds.csv` (таблица решений по порогам)

---

## Главные риски и как их снизить

| Риск | Вероятность | Митигация |
|------|-------------|-----------|
| Переобучение (малый датасет) | Средняя | 5-fold CV, early stopping, регуляризация |
| Модель зависит от CRP (утечка) | Низкая | Валидация на CRP>5, SHAP анализ |
| Плохая работа на мужчинах (почти все данные — женщины) | Высокая | Честно заявить ограничение, собрать данные РФ |
| Переобучение на NHANES (не РФ) | Средняя | Калибровка на пилоте, retrain на РФ данных |
| Низкий precision → раздражение пациентов | Средняя | Оптимизация порога, A/B-тест |

---

## Итог: с чего начать прямо сейчас

```bash
# 1. Обучить baseline (CatBoost, 5-fold CV)
python train_baseline.py --data X_29n.csv --target Y_IRON_DEFICIENCY --model catboost

# 2. SHAP анализ
python shap_analysis.py --model model_29n_id.cbm --data X_29n.csv

# 3. Экономическая оптимизация порогов
python optimize_threshold.py --model model_29n_id.cbm --scenario 29n
```

**Время**: ~3-5 дней от старта до презентабельных результатов.

**Что покажет**: работающая модель (AUROC ~0.80+), объяснимая (SHAP), с экономически обоснованными порогами для каждого сценария.
